<!DOCTYPE html>
<html lang="en" data-content_root="../">
<head>
	<meta name="generator" content="pandoc" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<meta name="description" content="PostgreSQL Presentation for UoA">

	<meta name="author" content="Georgios Kokolatos" />

	<title>Schema Testing</title>

	<link href="./css/bootstrap.min.css" rel="stylesheet">
	<link href="./css/custom.css" rel="stylesheet">

	<meta name="theme-color" content="#712cf9">

	<script>
		let inited = false;
		let baseFont = 0;
		let baseMarginTop = 0;
		let baseMarginBottom = 0;
		let basePaddingTop = 0;
		let basePaddingBottom = 0;

		function setContentWidth(value) {
			const container = document.getElementsByClassName("container");
			for (let i = 0; i < container.length; i++) {
				container[i].style.maxWidth = value;
					console.log(container[i].style.maxWidth);
				}
				setReferences("pw", value);
		}

		function setReference(id, name, val) {
			const ref = document.getElementById(id);
			if (ref !== "" && ref !== undefined && ref !== null) {
				let href = new URL(ref.href);
				let params =  new URLSearchParams(href.search);

				params.set(name, val);
				href.search = params.toString();
				ref.href = href.toString();
			}
		}

		function setReferences(name, val) {
			setReference("next_chapter", name, val);
			setReference("prev_chapter", name, val);
		}

		function initParams() {
			initFontSize();

			const params = new URLSearchParams(window.location.search);
			let pw = params.get("pw");
			if (pw !== null) {
				setContentWidth(pw);
			}
		}

		function getRootVariable(name) {
			return parseInt(getComputedStyle(document.documentElement).getPropertyValue(name).trim());
		}

		function setRootVariable(name, value) {
			document.documentElement.style.setProperty(name, value);
		}

		function updateSizingVariables(multiplier) {
			if (inited == false) {
				baseFont = getRootVariable('--base-font-size');
				baseMarginTop = getRootVariable('--base-margin-top');
				baseMarginBottom = getRootVariable('--base-margin-bottom');
				basePaddingTop = getRootVariable('--base-padding-top');
				basePaddingBottom = getRootVariable('--base-padding-bottom');
				inited = true;
			}
			setRootVariable('--base-font-size', (baseFont + multiplier) + 'px');
			setRootVariable('--base-margin-top', (baseMarginTop + multiplier * 1.3) + 'px');
			setRootVariable('--base-margin-bottom', (baseMarginBottom + multiplier * 1.3) + 'px');
			setRootVariable('--base-padding-top', (basePaddingTop + multiplier * 1.3) + 'px');
			setRootVariable('--base-padding-bottom', (basePaddingBottom + multiplier * 1.3) + 'px');
		}

		function initFontSize() {
			const params = new URLSearchParams(window.location.search);
			let fs = Number(params.get("fs")) || 0;
			let fontSizeSlider = document.getElementById("fontSizeSlider");

			fontSizeSlider.value = fs;
			updateSizingVariables(fs);
			setReferences("fs", fs);

			fontSizeSlider.addEventListener("input", function () {
				const val = parseInt(fontSizeSlider.value);

				updateSizingVariables(val);
				setReferences("fs", val);
			});
		}

		document.addEventListener("DOMContentLoaded", (event) => {
			initParams();
		});
	</script>
</head>
<body>
	<div class="container shadow-lg py-0 px-3 mb-5 rounded">
		<!-- Navbar -->
		<header class="sticky-top">
			<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
				<div class="container-fluid">
					<a class="navbar-brand" href="./chapter1.html">UoA PostgreSQL</a>
					<button class="navbar-toggler" type="button" data-bs-toggle="collapse"
							data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown"
							aria-expanded="false" aria-label="Toggle navigation"
					>
						<span class="navbar-toggler-icon"></span>
					</button>

					<div class="collapse navbar-collapse" id="navbarNavDropdown">
						<ul class="navbar-nav">
							<li class="nav-item dropdown">
								<a class="nav-link dropdown-toggle" href="#" role="button"
									data-bs-toggle="dropdown" aria-expanded="false">
									Page Contents
								</a>
								<ul class="dropdown-menu">
																		<li>
										<a class="dropdown-item" href="#schema-testing">7. Schema testing</a>
									</li>
																		<li>
										<a class="dropdown-item" href="#our-schema">7.1 Our schema</a>
									</li>
																		<li>
										<a class="dropdown-item" href="#a-rudimentary-example">7.2 A rudimentary
example</a>
									</li>
																	</ul>
							</li>
						</ul>

						<ul class="navbar-nav">
							<li class="nav-item dropdown position-static">
								<a class="nav-link dropdown-toggle" href="#" role="button"
									data-bs-toggle="dropdown" aria-expanded="false">
									Adjust Font Size
								</a>
								<ul class="dropdown-menu w-100 mt-0">
									<li class="p-1 m-1">
										<input type="range" class="form-range" min="0" max="40" step="2" id="fontSizeSlider">
									</li>
								</ul>
							</li>
						</ul>

						<ul class="navbar-nav">
							<li class="nav-item dropdown">
								<a class="nav-link dropdown-toggle" href="#" role="button"
									data-bs-toggle="dropdown" aria-expanded="false">
									Page Width
								</a>
								<ul class="dropdown-menu">
									<li>
										<button class="dropdown-item" onclick="setContentWidth('960px')">Narrow</button>
									</li>
									<li>
										<button class="dropdown-item" onclick="setContentWidth('1200px')">Large</button>
									</li>
									<li>
										<button class="dropdown-item" onclick="setContentWidth('80%')">Extra large</button>
									</li>
								</ul>
							</li>
						</ul>

						<!-- Prev and next links -->
						<ul class="navbar-nav ms-auto">
														<li class="nav-item">
								<a class="nav-link" id="prev_chapter" href="chapter6.html" title="Previous Chapter: Emergencies">
									&larr; Emergencies
								</a>
							</li>
																					<li class="nav-item">
								<a class="nav-link" id="next_chapter" href="chapter8.html" title="Next Chapter: Application
Interface">
									Application Interface &rarr;
								</a>
							</li>
													</ul>

					</div>
				</div>
			</nav>
		</header>

		<div id="content" class="content">
			<div class="container-fluid">
				<div class="row">
					<div class="body span12 content" role="main">
					<!-- Pandoc body -->
					<h1 id="schema-testing">7. Schema testing</h1>
<p>The schema definition provides a set of guarantees and functionality.
As a result, we hold several expectations. In order to be reasonably
certain that our expectations hold <strong><em>and</em></strong> that we
do not violate those expectations when we alter the schema, we need to
be contentiously testing them. A simple implementation of <em>regress
testing</em> usually suffices. Commonly, it forms part of a Continuous
Integration / Continuous Delivery environment.</p>
<p>However, a very simple rule such as:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> psql <span class="op">&lt;</span>connection string<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">--file</span> <span class="op">&lt;</span>input.sql<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--echo-queries</span> <span class="op">&gt;</span> generated.out <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span> <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">diff</span> generated.out <span class="op">&lt;</span>expected.out<span class="op">&gt;</span></span></code></pre></div>
<p>will suffice. Of course, date and time differences, floating point,
random generators etc, will require a more advanced implementation. One
highly recommended one, at least as a starting point, can be found in
Dimitri’s <a href="https://github.com/dimitri/regresql">github</a>.</p>
<h2 id="our-schema">7.1 Our schema</h2>
<pre><code>                         ┌────────────────────┐
                         │     vehicles       │
                         │────────────────────│
                         │ id (PK)            │
                         │ fleet_id           │
                         └────────┬───────────┘
                                  │ 
        ┌─────────────────────────┴─────────────────────────┐
        ▼                          ▼                        ▼
┌────────────────────┐   ┌────────────────────┐   ┌────────────────────┐
│ vehicle_location   │   │ vehicle_state      │   │ emergency_vehicles │
│────────────────────│   │────────────────────│   │────────────────────│
│ location_id (PK)   │   │ state_id (PK)      │   │ id (PK)            │
│ timestamp          │   │ timestamp          │   │ vehicle_id (FK) ◄──┘
│ vehicle_id (FK)  ◄─┘   │ vehicle_id (FK) ◄──┘   │ emergency_id (FK) ◄┐
│ location           │   │ state (enum)       │   │ timestamp          │
└────────────────────┘   └────────────────────┘   │ status (enum)      │
                                                  └────────────────────┘
                                                           ▲
                                                           │
                                                           │
                                             ┌──────────────────────────┐
                                             │     emergencies          │
                                             │──────────────────────────│
                                             │ id (PK)                  │
                                             │ location (geom)          │
                                             │ description              │
                                             └────────┬─────────────────┘
                                                      │ 
                                                      ▼
                                        ┌──────────────────────────────┐
                                        │     emergency_state          │
                                        │──────────────────────────────│
                                        │ state_id (PK)                │
                                        │ emergency_id (FK) ◄──────────┘
                                        │ timestamp                    │
                                        │ state (enum)                 │
                                        └──────────────────────────────┘
</code></pre>
<h2 id="a-rudimentary-example">7.2 A rudimentary example</h2>
<p>A simple input file for regress testing the vehicle related relations
may look like this:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">--------------------------------------------------------------------------------</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- Vehicles section</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">--------------------------------------------------------------------------------</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- Validity of fleet_id</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- Should fail, lowercase</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;aaa-001&#39;</span>);</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- Should fail, length</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;AAA-001 &#39;</span>);</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">--Should fail, wrong pattern</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;AAAA-01&#39;</span>);</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;AAA-01A&#39;</span>);</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39; AA-010&#39;</span>);</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;AAA+001&#39;</span>);</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co">-- Should succeed</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;AAA-000&#39;</span>);</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co">-- Should fail with unique violation</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;AAA-000&#39;</span>);</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co">-- Validity of state</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co">-- Successful insert into vehicles must generate an entry in states</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    v.fleet_id,</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    vs.state</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    vehicle_state vs <span class="kw">JOIN</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    vehicles v <span class="kw">ON</span> (</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        v.<span class="kw">id</span> <span class="op">=</span> vs.vehicle_id</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    v.fleet_id <span class="op">=</span> <span class="st">&#39;AAA-000&#39;</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="co">-- Should fail for invalid state</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    vehicle_state (vehicle_id, state)</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> vehicles <span class="kw">WHERE</span> fleet_id <span class="op">=</span> <span class="st">&#39;AAA-000&#39;</span>),</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;invalid&#39;</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="co">-- Should fail for unique violation</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    vehicle_state (vehicle_id, <span class="dt">timestamp</span>, state)</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> vehicles <span class="kw">WHERE</span> fleet_id <span class="op">=</span> <span class="st">&#39;AAA-000&#39;</span>),</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">SELECT</span> <span class="dt">timestamp</span> <span class="kw">FROM</span> vehicle_state <span class="kw">WHERE</span> state <span class="op">=</span> <span class="st">&#39;commissioned&#39;</span>),</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;commissioned&#39;</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="co">-- Validity of location</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a><span class="co">-- Should fail, not in Lesvos</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    vehicle_location (vehicle_id, location)</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> vehicles <span class="kw">WHERE</span> fleet_id <span class="op">=</span> <span class="st">&#39;AAA-000&#39;</span>),</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    ST_Transform(ST_Point(<span class="fl">39.177156</span>, <span class="fl">26.373316</span>, <span class="dv">4326</span>), <span class="dv">2100</span>)</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a><span class="co">-- Should succeed</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    vehicle_location (vehicle_id, location)</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> vehicles <span class="kw">WHERE</span> fleet_id <span class="op">=</span> <span class="st">&#39;AAA-000&#39;</span>),</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    ST_Transform(ST_Point(<span class="fl">26.373316</span>, <span class="fl">39.177156</span>, <span class="dv">4326</span>), <span class="dv">2100</span>)</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a><span class="co">-- All data should be present</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    v.fleet_id,</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    vs.state,</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    ST_AsText(ST_Transform(vl.location, <span class="dv">4326</span>)) <span class="kw">AS</span> <span class="ot">&quot;location WGS84&quot;</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    vehicles v <span class="kw">JOIN</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    vehicle_state vs <span class="kw">ON</span></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>        v.<span class="kw">id</span> <span class="op">=</span> vs.vehicle_id <span class="kw">JOIN</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    vehicle_location vl <span class="kw">ON</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>        v.<span class="kw">id</span> <span class="op">=</span> vl.vehicle_id</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a><span class="co">-- Delete from vehicle_location should archive</span></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a><span class="co">--</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="kw">FROM</span></span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>    vehicle_location vl</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a><span class="kw">USING</span></span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>    vehicles v</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>    v.fleet_id <span class="op">=</span> <span class="st">&#39;AAA-000&#39;</span> <span class="kw">AND</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>    vl.vehicle_id <span class="op">=</span> v.<span class="kw">id</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>    ST_AsText(ST_Transform(location, <span class="dv">4326</span>)) <span class="kw">AS</span> <span class="ot">&quot;location WGS84&quot;</span></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">archive</span>.vehicle_location</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>;</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>    </span></code></pre></div>
<p>Which should generate an output like this:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:12</span>: ERROR:  <span class="kw">new</span> <span class="kw">row</span> <span class="cf">for</span> relation <span class="ot">&quot;vehicles&quot;</span> violates <span class="kw">check</span> <span class="kw">constraint</span> <span class="ot">&quot;valid_fleet_identifier&quot;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>DETAIL:  Failing <span class="kw">row</span> <span class="kw">contains</span> (<span class="dv">1</span>, aaa<span class="op">-</span><span class="dv">001</span>).</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:12</span>: STATEMENT:  <span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;aaa-001&#39;</span>);</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:15</span>: ERROR:  <span class="kw">new</span> <span class="kw">row</span> <span class="cf">for</span> relation <span class="ot">&quot;vehicles&quot;</span> violates <span class="kw">check</span> <span class="kw">constraint</span> <span class="ot">&quot;valid_fleet_identifier&quot;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>DETAIL:  Failing <span class="kw">row</span> <span class="kw">contains</span> (<span class="dv">2</span>, AAA<span class="op">-</span><span class="dv">001</span> ).</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:15</span>: STATEMENT:  <span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;AAA-001 &#39;</span>);</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:18</span>: ERROR:  <span class="kw">new</span> <span class="kw">row</span> <span class="cf">for</span> relation <span class="ot">&quot;vehicles&quot;</span> violates <span class="kw">check</span> <span class="kw">constraint</span> <span class="ot">&quot;valid_fleet_identifier&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>DETAIL:  Failing <span class="kw">row</span> <span class="kw">contains</span> (<span class="dv">3</span>, AAAA<span class="op">-</span><span class="dv">01</span>).</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:18</span>: STATEMENT:  <span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;AAAA-01&#39;</span>);</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:19</span>: ERROR:  <span class="kw">new</span> <span class="kw">row</span> <span class="cf">for</span> relation <span class="ot">&quot;vehicles&quot;</span> violates <span class="kw">check</span> <span class="kw">constraint</span> <span class="ot">&quot;valid_fleet_identifier&quot;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>DETAIL:  Failing <span class="kw">row</span> <span class="kw">contains</span> (<span class="dv">4</span>, AAA<span class="op">-</span><span class="dv">01</span>A).</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:19</span>: STATEMENT:  <span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;AAA-01A&#39;</span>);</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:20</span>: ERROR:  <span class="kw">new</span> <span class="kw">row</span> <span class="cf">for</span> relation <span class="ot">&quot;vehicles&quot;</span> violates <span class="kw">check</span> <span class="kw">constraint</span> <span class="ot">&quot;valid_fleet_identifier&quot;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>DETAIL:  Failing <span class="kw">row</span> <span class="kw">contains</span> (<span class="dv">5</span>,  AA<span class="op">-</span><span class="dv">010</span>).</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:20</span>: STATEMENT:  <span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39; AA-010&#39;</span>);</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:21</span>: ERROR:  <span class="kw">new</span> <span class="kw">row</span> <span class="cf">for</span> relation <span class="ot">&quot;vehicles&quot;</span> violates <span class="kw">check</span> <span class="kw">constraint</span> <span class="ot">&quot;valid_fleet_identifier&quot;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>DETAIL:  Failing <span class="kw">row</span> <span class="kw">contains</span> (<span class="dv">6</span>, AAA<span class="op">+</span><span class="dv">001</span>).</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:21</span>: STATEMENT:  <span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;AAA+001&#39;</span>);</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="dv">0</span> <span class="dv">1</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:27</span>: ERROR:  duplicate <span class="kw">key</span> <span class="fu">value</span> violates <span class="kw">unique</span> <span class="kw">constraint</span> <span class="ot">&quot;vehicles_fleet_id_key&quot;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>DETAIL:  <span class="kw">Key</span> (fleet_id)<span class="op">=</span>(AAA<span class="op">-</span><span class="dv">000</span>) already <span class="kw">exists</span>.</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:27</span>: STATEMENT:  <span class="kw">INSERT</span> <span class="kw">INTO</span> vehicles (fleet_id) <span class="kw">VALUES</span> (<span class="st">&#39;AAA-000&#39;</span>);</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a> fleet_id |    state     </span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co">----------+--------------</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a> AAA<span class="op">-</span><span class="dv">000</span>  | commissioned</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span> <span class="kw">row</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:52</span>: ERROR:  invalid input <span class="fu">value</span> <span class="cf">for</span> enum vehicle_state_enum: <span class="ot">&quot;invalid&quot;</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>LINE <span class="dv">5</span>:  <span class="st">&#39;invalid&#39;</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>         ^</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:52</span>: STATEMENT:  <span class="kw">INSERT</span> <span class="kw">INTO</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    vehicle_state (vehicle_id, state)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> vehicles <span class="kw">WHERE</span> fleet_id <span class="op">=</span> <span class="st">&#39;AAA-000&#39;</span>),</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;invalid&#39;</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:61</span>: ERROR:  duplicate <span class="kw">key</span> <span class="fu">value</span> violates <span class="kw">unique</span> <span class="kw">constraint</span> <span class="ot">&quot;vehicle_state_vehicle_id_timestamp_state_key&quot;</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>DETAIL:  <span class="kw">Key</span> (vehicle_id, <span class="ot">&quot;timestamp&quot;</span>, state)<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">2025</span><span class="op">-</span><span class="dv">04</span><span class="op">-</span><span class="dv">23</span> <span class="dv">19</span><span class="ch">:39:11</span><span class="fl">.177991</span><span class="op">+</span><span class="dv">02</span>, commissioned) already <span class="kw">exists</span>.</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:61</span>: STATEMENT:  <span class="kw">INSERT</span> <span class="kw">INTO</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    vehicle_state (vehicle_id, <span class="dt">timestamp</span>, state)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> vehicles <span class="kw">WHERE</span> fleet_id <span class="op">=</span> <span class="st">&#39;AAA-000&#39;</span>),</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">SELECT</span> <span class="dt">timestamp</span> <span class="kw">FROM</span> vehicle_state <span class="kw">WHERE</span> state <span class="op">=</span> <span class="st">&#39;commissioned&#39;</span>),</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;commissioned&#39;</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:73</span>: ERROR:  Location (POINT(<span class="fl">2024724.3888534778</span> <span class="fl">3007855.7431474472</span>)) <span class="kw">out</span> <span class="kw">of</span> bounds</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>HINT:  Please <span class="kw">check</span> that <span class="kw">the</span> location <span class="kw">is</span> within Lesvos</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="kw">CONTEXT</span>:  PL<span class="op">/</span>pgSQL <span class="kw">function</span> fn_location_check() line <span class="dv">14</span> <span class="kw">at</span> RAISE</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>psql<span class="ch">:src</span><span class="op">/</span>sql<span class="op">/</span>regress_test.sql<span class="ch">:73</span>: STATEMENT:  <span class="kw">INSERT</span> <span class="kw">INTO</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    vehicle_location (vehicle_id, location)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="kw">VALUES</span> (</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">SELECT</span> <span class="kw">id</span> <span class="kw">FROM</span> vehicles <span class="kw">WHERE</span> fleet_id <span class="op">=</span> <span class="st">&#39;AAA-000&#39;</span>),</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    ST_Transform(ST_Point(<span class="fl">39.177156</span>, <span class="fl">26.373316</span>, <span class="dv">4326</span>), <span class="dv">2100</span>)</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="dv">0</span> <span class="dv">1</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a> fleet_id |    state     |               location WGS84                </span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="co">----------+--------------+---------------------------------------------</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a> AAA<span class="op">-</span><span class="dv">000</span>  | commissioned | POINT(<span class="fl">26.373315987937836</span> <span class="fl">39.17715598285773</span>)</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span> <span class="kw">row</span>)</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="kw">DELETE</span> <span class="dv">1</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>               location WGS84                </span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="co">---------------------------------------------</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a> POINT(<span class="fl">26.373315987937836</span> <span class="fl">39.17715598285773</span>)</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span> <span class="kw">row</span>)</span></code></pre></div>
					<!-- Endi of Pandoc body -->
					</div>
			</div>

			<footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
				<p class="col-md-4 mb-0 text-body-secondary">
					© 2025 Georgios Kokolatos
				</p>
				<p class="col-md-4 mb-0 text-body-secondary">
					<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer">
						CC BY-NC-SA 4.0
					</a>
					<img  style="height:1em; margin-left:0.3em;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt="">
					<img  style="height:1em; margin-left:0.3em;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt="">
					<img  style="height:1em; margin-left:0.3em;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1" alt="">
					<img  style="height:1em; margin-left:0.3em;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" alt="">
				</p>
				<ul class="nav col-md-4 justify-content-end">
					<li class="nav-item">
						<a href="#" class="nav-link px-2 text-body-secondary">Back to top</a>
					</li>
				</ul>
			</footer>
		</div>
	</div>
	<script src="./js/bootstrap.bundle.min.js"></script>
</body>
</html>
